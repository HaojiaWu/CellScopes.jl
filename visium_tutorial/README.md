# Analysis and visualization of Visium data with CellScopes.jl
Below are some simple codes to walk you through how to use ```CellScopes.jl``` to analyze the Visium data generated by the 10x spaceranger tool.

## 1. Read the visium data

We provide a function that can directly read the visium data and create a visium spatial object for downstream analysis. The spots and genes can be filtered by setting the parameters ```min_gene``` and ```min_cell``` in this step.

```julia
import CellScopes as cs
sham = cs.read_visium("/home/data/Jia/shamA_visium/MGI0805_A3_147_msham/outs/")
```
This should create an data type called ```VisiumObject```.
```
VisiumObject in CellScopes.jl
Genes x Cells = 17592 x 1815
Available data:
- rawCount
- metaData
- spmetaData
- imageData
All fields:
- rawCount
- normCount
- scaleCount
- metaData
- spmetaData
- varGene
- dimReduction
- clustData
- imageData
```

### 2. Normalization, dimension reduction and cell clustering
We then perform data normalization, dimension reduction and cell clustering on the Visium Object.
```julia
sham = cs.normalize_object(sham; scale_factor = 10000)
sham = cs.scale_object(sham)
sham = cs.find_variable_genes(sham; nFeatures = 1000)
sham = cs.run_pca(sham;  method=:svd, pratio = 1, maxoutdim = 10)
sham = cs.run_umap(sham; min_dist=0.2, n_neighbors=20)
sham = cs.run_clustering(sham; res=0.01, n_neighbors=20)
```
### 3. Visiualization
We provide a set of functions to help visualize the cell and gene expression on the dimension reduction space and the spatial space.

#### 3.1 Cell type visualization
##### a. Visualize the cell clustering on UMAP.
```julia
cs.dim_plot(sham; dim_type ="umap", marker_size=8)
```
<img src="https://github.com/HaojiaWu/CellScopes.jl/blob/main/data/umap_vsm.png" width="600"> 

##### b. Visualize the cell type distribution on tissue
```julia
cs.sp_dim_plot(sham, "cluster"; 
    marker_size = 8, canvas_size = (600,500), 
    do_label=false)
```
<img src="https://github.com/HaojiaWu/CellScopes.jl/blob/main/data/sp_vsm.png" width="600"> 
The transparency can be adjusted by setting the ```alpha``` parameter.
```julia
cs.sp_dim_plot(sham, "cluster"; 
    marker_size = 8, canvas_size = (600,500), 
    do_label=false, alpha=0.3)
```
<img src="https://github.com/HaojiaWu/CellScopes.jl/blob/main/data/sp_vsm_transparent.png" width="600"> 

The image can be croped by setting the ```x_lims``` and ```y_lims``` parameters.

```julia
cs.sp_dim_plot(sham, "cluster"; do_label = false, do_legend = true, img_res = "low",
    marker_size = 8, canvas_size=(600,500), adjust_contrast = 1, 
    adjust_brightness= 0.1, alpha =0.4,  x_lims=(200, 440), 
    y_lims=(200, 400))
```
<img src="https://github.com/HaojiaWu/CellScopes.jl/blob/main/data/sp_vsm_crop.png" width="600"> 

##### c. Highlight the cell type of interest

#### 3.2 Gene expression visiualization
Plot genes on whole kidney:

```julia
cs.sp_feature_plot(sham, ["Aqp2","Slc7a13", "Umod", "Slc12a1","Slc12a3","Slc34a1"]; 
    marker_size = 8, color_keys=["gray90", "lemonchiffon" ,"red"], 
    adjust_contrast=1, adjust_brightness = 0.3, alpha=1)
```
<img src="https://github.com/HaojiaWu/CellScopes.jl/blob/main/data/sp_feature.png" width="600"> 

Plot genes on the selected reagion:

```julia
cs.sp_feature_plot(sham, ["Aqp2","Slc7a13", "Umod", "Slc12a1","Slc12a3","Slc34a1"]; 
    marker_size = 8, color_keys=["gray90", "lemonchiffon" ,"red"], 
    adjust_contrast=1, adjust_brightness = 0.3, alpha=1,  x_lims=(200, 440), y_lims=(200, 400))
```
<img src="https://github.com/HaojiaWu/CellScopes.jl/blob/main/data/sp_feature_select.png" width="600"> 





